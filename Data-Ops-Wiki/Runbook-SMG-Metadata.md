|Field|Value|
|--|--|
|**Status**|Draft|
|**Version**| v0.1|
|**Date**|08-September-2023|
|**Technical owner**|Sarbjit Sarkaria|
|**Business lead**|Yuri Fedoruk|
|**Tickets**| #2561

[[_TOC_]]

# Introduction

This runbook consists details regarding metadata requirements and results for the `TOWWORKS` and `PPA` which might be updated in future if new requirements comes up.

# Requirement

To build out a new view/report to get the Last Updated Time a particular table has been updated in both silver and gold databases for **Towworksv2** and **PPA**. The new report should be created as **metadata.vw_REPORT_LastUpdatedTime**.

# Dependent data sources

To generate the `metadata.vw_REPORT_LastUpdatedTime` report the following data sources must be used
**cfgbronze** – to get the Last Updated Time for silver tables present in Towworksv2 and PPA.
**Log Analytics Workspace(LAW)** – using KQL query to get the Last Updated Time for gold tables present in Towworksv2 and PPA.

# Overview of process
•	To generate this report a new pipeline has been created in `adfv2-towworks-CICDProd` under the name `PL_Table_LastUpdatedTime` with an hourly trigger enabled which would run in half hour intervals after the main pipelines PPA and Towworksv2 runs.
•	A new synapse script has been developed in `syn-smg-prod` under the name `Create LastUpdatedTime` view to generate the view `metadata.vw_REPORT_LastUpdatedTime`.

# Steps Involved
## Pipeline Creation

•	The Pipeline is built to get the data from two sources one would be cfgbronze and the other would be Log Analytics Workspace(LAW).
•	To get the data from LAW by using KQL query which would restrict for getting the data for gold tables present in Towworksv2 and PPA. The following KQL query has been used:
```
{
    "query" : "ADFActivityRun | 
               where TimeGenerated > ago(24h) | 
               where ActivityName in ('Update Exception Report', 'Update Fleet Performance report', 'Update Valid Events Report', 'Update PPA Market Share Report') | 
               where Status == 'Succeeded' | 
               summarize TimeGenerated = max(TimeGenerated) by ActivityName | 
               extend db = 'gold' "
}
```
•	Create linked service to connect to log Analytics in the name of `LS_LAW_REST` with base url pointing to LAW workspace URI and authentication to be anonymous.
•	Create datasets under the name `DS_METADATA_REST` and `DS_METADATA_PARQUET` where
**DS_METADATA_REST** -  will point to log analytics workspace.
**DS_METADATA_PARQUET** – will point to processed container of `adlssmgprod` storage account where we store the output of copy data activity in the form of parquet file. The filename for the parquet file to be stored by creating a new parameter `pFileName` within the dataset. The path of the parquet file be `processed/gold/METADATA/LASTUPDATEDREPORT/`
•	Firstly, we use the web activity in the name of `GET spSecret`  in order to get the service principal secret as shown below 
![spsecret.png](/.attachments/spsecret-95e6937d-fdb0-44e3-8569-deb0257a91a6.png =600x)
•	Next, we need to another web activity in the name of Get Access Token to get the essential Bearer Token to connect with the LAW. The following settings need to be updated while getting the access token
![access token.png](/.attachments/access%20token-94fb41ef-556b-47fc-a5cf-6462891e7477.png =600x)
•	Copy data activity should be used as a next step to get the LAW data from KQL query. The KQL query should be passed as a json string in the request body portion of source tab. Two additional headers should also be passed in as Content-Type , Authorization as below
![content type.png](/.attachments/content%20type-2af7c65a-078b-4b8b-b5b3-e8f2949f1b87.png =600x)
Sink tab of the copy data activity should be pointing to `DS_METADATA_PARQUET` where we store the output of source dataset. 
**Note:** In future, if we have more reports being generated then it’s ideal to update the KQL query to get the anticipated gold report that needs to be generated by just adding the activity name of gold report as below
```
where ActivityName in ('Update Exception Report', 'Update Fleet Performance report', 'Update Valid Events Report', 'Update PPA Market Share Report', ‘’,’’)
```
Just add the `ActivityName` of gold report in the single quotes at the end as shown above
•	Next add a separate copy data activity to get the data from the cfgbronze to get the LastUpdatedTime of silver tables. The source tab should be pointing to `DS_cfgbronze_ATS` where we add an additional column `‘db’ = ‘silver’`. The sink tab should be pointing to `DS_METADATA_PARQUET` where we store the output of source dataset.
•	Here is the overview of the entire pipeline
![pipeline.png](/.attachments/pipeline-350186db-787d-4436-941c-4a632c314e81.png =600x)


# Table details

|Table Name|Database|
|--|--|
|towworks.vw_DIM_ASSET| Silver |
|towworks.vw_DIM_CARGO| Silver |
|towworks.vw_DIM_COMPANY| Silver |
|towworks.vw_DIM_CUSTOMCOLORS| Silver |
|towworks.vw_DIM_ETAESTIMATES| Silver |
|towworks.vw_DIM_LOCATION| Silver |
|towworks.vw_DIM_UNITOFMEASURE| Silver |
|towworks.vw_DIM_WORKORDERSTATUS| Silver |
|towworks.vw_FACT_APINVOICES| Silver |
|towworks.vw_FACT_ARINVOICES| Silver |
|towworks.vw_FACT_BASEAUDIT| Silver |
|towworks.vw_FACT_CONTRACTS| Silver | 
|towworks.vw_FACT_DELETEDEVENTS| Silver | 
|towworks.vw_FACT_DELETIONAUDIT| Silver |
|towworks.vw_FACT_EVENT| Silver |
|towworks.vw_FACT_DISTRIBUTIONS| Silver |
|towworks.vw_FACT_LOGISTICSORDERS| Silver|
|towworks.vw_FACT_LOGiSTICSORDERSLINEITEMCARGO| Silver| 
|towworks.vw_FACT_LOGISTICORDERSLINEITEMS| Silver| 
|towworks.vw_FACT_RATEESCALATORS| Silver|
|towworks.vw_FACT_RATES| Silver|
|towworks.vw_FACT_ROUTEPARTIES | Silver| 
|towworks.vw_FACT_TRANSACTIONS | Silver|
|towworks.vw_FACT_WORKORDERLINKS| Silver| 
|towworks.vw_FACT_WORKORDERS| Silver| 
|towworks.vw_FACT_WORKSORDERSASUPPLEMENT| Silver|
|towworks.vw_FACT_WORKTASKS| Silver| 
|ppa.vw_DIM_Vessels| Silver|
|ppa.vw_DIM_Organizations| Silver|
|ppa.vw_DIM_Pilots| Silver|
|ppa.vw_DIM_Locations| Silver|
|ppa.vw_FACT_Jobs| Silver|
|ppa.vw_REPORT_PPA_MARKET_SHARE| Gold|
|towworks.vw_Valid_Events_Report| Gold|
|towworks.vw_Fleet_Performance_Report| Gold|
|towworks.vw_Exception_Report| Gold|

Add the view and database details to the above table if they are added in the metadata.

# Appendix
`TODO: Needs to be updated`

# References
`TODO: Needs to be updated`
|Field|Value|
|--|--|
|**Status**|Draft|
|**Version**| v0.1|
|**Date**|05-Oct-2023|
|**Technical owner**|Sarbjit Sarkaria|
|**Business lead**|Yuri Fedoruk|
|**Tickets**| #2775 <br>  #2851 <br>

[[_TOC_]]

# Introduction
The purpose of Transient ETL for Towworks v2 is to increase the frequency of data retrieval for some datasets which are going to be used along with telemetry data.

The solution developed for this is by building a `Function APP` to get the data for every 5 minutes from Towworks.

# Scope
The scope of the solution is limited to datasets `EVENTS, WORKORDERS` which are going to be used by other data to generate reports.

## Requirements
Id | Requirement | Description
---|---|---
1 | JSON| The ETL shall process the incoming JSON data from Towworks and flatten it.
2 | Frequency | The ETL shall procure data every 5 minutes from Towworks. 
3 | Silver | The processed data shall be curated to `transient/silver/TOWWORKS`
4 | Curated files | Once processed & flattened, the incoming data shall be saved with filename as `dataset-timestamp.parquet` in parquet format.
5 | Retention Period | Data in silver layer will stay for 65 minutes and once a file is more than 65 minutes old, file will deleted from blob as same data will be sent from `towworks-adf`.
6 | View | The curated data shall be exposed by a silver view in Synapse called `[towworks].[vw_tranisent_FACT_*]`


# ETL Design
The ETL solution is centered around a schedule-triggered Azure function app. The function app performs all data procurement, transformation and curation operations. It is lightweight and fast, typically running in around 4 seconds. All data is curated in `adlssmgdev/prod`.

## Curated Data Format
Curated data is being stored in `parquet` format as the existing data from `adf` is being stored in parquet format and as we are only going to keep data for around ~65 minutes (approx 13 files) which won't consume much storage in delta lake.

We are using parquet format as there are some records in the datasets which are of more period than the `65 minutes` retention period and these records can't be deleted so there will be union of data between data from `Function App` (real time data) and `towworks-adf` (running hourly), with the Union of data we will be having data for every 5 minutes and past data from adf.

## Azure Infrastructure Design
Hosting a function app requires access to a storage account. Since the storage account is firewall protected, access to it is via a virtual network. Both the storage account and function app must operate within the same vnet. Function apps can be billed on a pay-per-use basis, referred to as a consumption plan. However consumption plans do not support vnet access. As such, the function app used for this ETL operates on a service plan ([`P0V3`](https://portal.azure.com/#view/WebsitesExtension/ScaleSpecPicker.ReactView/id/%2Fsubscriptions%2Fe2764bf7-bdda-4887-aa05-42f41431e1c1%2FresourceGroups%2Frg-smg-towworks-dev%2Fproviders%2FMicrosoft.Web%2Fserverfarms%2Fasp-maretron-v2-dev)), albeit a low cost one. `TBD` The even cheaper `S1` plan should be tried.

![1.png](/.attachments/1-7769df24-785e-4eff-a2fe-c49cda25ab41.png)

## Components
Item Type | Name | Description
----|---|---
Storage Account | `adlssmg` | This is the storage account is common to and used by all SMG ETL deployments.
Virtual Network | `vnet-smg` | The storage account is attached to a virtual net. All other SMG components, including function apps, data factories and Databricks workspaces can only access the data via this vnet.
Function App | `fa-towworksv2` | The function app that is responsible for data procurement, transformation & curation. It hosts a single function called `api2parquet`. The function is automatically triggered every 5 minutes.
Service Plan | `asp-maretron-v2` | The function app is associated with this service plan. The service plan can be either scaled vertically or horizontally. Given that the processing load is quite light, compute costs can be kept to a minimum. Though with a service plan, billing is 24/7.
Application Insights | `ai-towworks-v2` | An invaluable component during the development process or for troubleshooting. This enables access and visibility to the logs generated by the function app. If necessary, it is also possible to view the logs in a live stream.
### Resource Groups
RG | Scope
--|--
`rg-smg-common` | Building function app in this resource group as this transient work is part of towworks.

### Networking
As mentioned earlier, access to data in a firewalled storage account is not trivial, even for other Azure components within the same subscription. The following must be established:
1. Create or identify a `VNET` associated with the target storage account:<br>
![2.png](/.attachments/2-29e93922-4b16-41f9-9bdc-0ba8e4a8c327.png =600x)

2. Enable vnet integration on the function app and attach to an available subnet:<br>
![3.png](/.attachments/3-5563df53-6be3-4363-af0c-04b5039f88fe.png =400x)


# Data Serving
The curated data is served via a view called `towworks.vw_transient_FACT` in the silver database of `smg-syn`.

# Data Sources & Sinks
## Data Sources
All data is obtained via the Maretron API.<br>
|Name|Source|Description|Sample|
|--|--|--|--|
|Dataset Contents|REST API|`https://seaspan.towworks.com/custom/seaspan/processes/TWDataBroker.aspx?`<br> `username`: `seaspanapi`<br>`password`: See @<Yuri Fedoruk> <p>|![4.png](/.attachments/4-29f89ee3-236b-4709-9916-4735128bee7c.png =300x)
 
## Data Sinks
The goal of this function app is to convert the raw xml data into csv format. One csv file is generated and the data gets appended to same csv file whenever the function app runs.

The following describe the data generated by the function app:
|Name|Sink|Description|
|--|--|--|
|Parquet|* storage: `adlssmgprod`<br/>* container: `transient` <br/> * folder: `silver/TOWWORKS`| Curated files are saved in this location in parquet format.|

# Troubleshooting and Maintenance
It is recommended that the log output accessible via application insights are used. They can be found here:<br>
![5.png](/.attachments/5-dc172988-f254-48a1-bc56-2b3fb61bf8cc.png =200x)

# Synapse Views

|Storage| View Name| Description|
|--|--|--|
|silver| vw_transient_FACT_*| Transient view is the view built on the data from `Parquet` format of Function App.|
|gold| vw_FACT_*_realtime| Realtime view is the `Union` of views from `Transient` (vw_tranient_FACT_*) data i.e every `5 minute` data and `ADF` (vw_FACT_*) data i.e every `1 hour` interval data.|

Note: '*' indicates dataset name, in this case it is `'EVENTS','WORKORDERS'` and dataset might change depending on requirement.

# Promoting Content from Dev to Prod

Created a new Function App in production environment and deployed the code from VS code. 

# References
[function app](https://dev.azure.com/seaspan-edw/SMG-DataOps/_git/towworksv2-functionapp?path=/api2parquet/__init__.py)
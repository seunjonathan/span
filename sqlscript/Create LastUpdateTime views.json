{
	"name": "Create LastUpdateTime views",
	"properties": {
		"content": {
			"query": "-- This script would enable to create view for the data we are getting from cfgbronze and log analytics workspace for the silver\n-- and gold tables which we require for Towworksv2 and PPA.\n\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'gold')\nBEGIN\n    CREATE DATABASE [gold]\nEND\nGO\n\n-- USE gold\n\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'metadata')\nBEGIN\n    EXEC ('CREATE SCHEMA metadata;');\nEND\nGO\n\n-- Create file format if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'DeltaLakeFormat')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = PARQUET );\nEND\nGO\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'DeltaLakeStorage')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE DeltaLakeStorage\n    WITH (\n        LOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net'\n    )\nEND\nGO\n\n-- Create view for the LastUpdatedTime Report\nCREATE OR ALTER VIEW [metadata].[vw_REPORT_LastUpdatedTime]\nAS select *\n-- The naming convetions should be modified for output values of column \"TableName\" as we require them to be in view format\nfrom (select\n       CASE\n          WHEN \"TableName\" = 'Update PPA Market Share Report' then 'ppa.vw_REPORT_PPA_MARKET_SHARE'\n          WHEN \"TableName\" = 'Update Valid Events Report' then 'towworks.vw_Valid_Events_Report'\n          WHEN \"TableName\" = 'Update Fleet Performance Report' then 'towworks.vw_Fleet_Performance_Report'\n          WHEN \"TableName\" = 'Update Exception Report' then 'towworks.vw_Exception_Report'\n          WHEN \"TableName\" = 'Jobs' then 'ppa.vw_FACT_Jobs'\n          WHEN \"TableName\" = 'Locations' then 'ppa.vw_DIM_Locations'\n          WHEN \"TableName\" = 'Pilots' then 'ppa.vw_DIM_Pilots'\n          WHEN \"TableName\" = 'Vessels' then 'ppa.vw_DIM_Vessels'\n          WHEN \"TableName\" = 'Organizations' then 'ppa.vw_DIM_Organizations'\n          When \"TableName\" = 'ASSET' then 'towworks.vw_DIM_ASSET'\n          When \"TableName\" = 'CARGO' then 'towworks.vw_DIM_CARGO'\n          When \"TableName\" = 'COMPANY' then 'towworks.vw_DIM_COMPANY'\n          When \"TableName\" = 'CUSTOMCOLORS' then 'towworks.vw_DIM_CUSTOMCOLORS'\n          When \"TableName\" = 'ETAESTIMATES' then 'towworks.vw_DIM_ETAESTIMATES'\n          When \"TableName\" = 'LOCATION' then 'towworks.vw_DIM_LOCATION'\n          When \"TableName\" = 'UNITOFMEASURE' then 'towworks.vw_DIM_UNITOFMEASURE'\n          When \"TableName\" = 'RATES' then 'towworks.vw_FACT_RATES'\n          When \"TableName\" = 'APINVOICES' then 'towworks.vw_FACT_APINVOICES'\n          When \"TableName\" = 'ARINVOICES' then 'towworks.vw_FACT_ARINVOICES'\n          When \"TableName\" = 'BASEAUDIT' then 'towworks.vw_FACT_BASEAUDIT'\n          When \"TableName\" = 'CONTRACTS' then 'towworks.vw_FACT_CONTRACTS'\n          When \"TableName\" = 'DELETEDEVENTS' then 'towworks.vw_FACT_DELETEDEVENTS'\n          When \"TableName\" = 'DELETIONAUDIT' then 'towworks.vw_FACT_DELETIONAUDIT'\n          When \"TableName\" = 'EVENTS' then 'towworks.vw_FACT_EVENTS'\n          When \"TableName\" = 'LOGISTICSORDERS' then 'towworks.vw_FACT_LOGISTICSORDERS'\n          When \"TableName\" = 'LOGISTICSORDERSLINEITEMCARGO' then 'towworks.vw_FACT_LOGISTICSORDERSLINEITEMCARGO'\n          When \"TableName\" = 'LOGISTICSORDERSLINEITEMS' then 'towworks.vw_FACT_LOGISTICSORDERSLINEITEMS'\n          When \"TableName\" = 'RATEESCALATORS' then 'towworks.vw_FACT_RATEESCALATORS'\n          When \"TableName\" = 'ROUTEPARTIES' then 'towworks.vw_FACT_ROUTEPARTIES'\n          When \"TableName\" = 'TRANSACTIONS' then 'towworks.vw_FACT_TRANSACTIONS'\n          When \"TableName\" = 'TRIPS' then 'towworks.vw_FACT_TRIPS'\n          When \"TableName\" = 'WORKORDERLINKS' then 'towworks.vw_FACT_WORKORDERLINKS'\n          When \"TableName\" = 'WORKORDERS' then 'towworks.vw_FACT_WORKORDERS'\n          When \"TableName\" = 'WORKORDERSTATUS' then 'towworks.vw_FACT_WORKORDERSTATUS'\n          When \"TableName\" = 'WORKTASKS' then 'towworks.vw_FACT_WORKTASKS'\n          When \"TableName\" = 'WORKORDERSASUPPLEMENT' then 'towworks.vw_FACT_WORKORDERSASUPPLEMENT'\n        END as \"TableName\",\n        (CAST(\"LastUpdatedTime\" AS DATETIME2) at time zone 'UTC') AT TIME ZONE 'Pacific Standard Time' as \"LastUpdatedTime\",\n        \"db\"\n    FROM \n    OPENROWSET(\n            BULK 'gold/METADATA/LASTUPDATEDREPORT',\n            DATA_SOURCE = 'DeltaLakeStorage',\n            FORMAT='PARQUET'\n    )\n\n    with (\n        \"TableName\" VARCHAR(255),\n        \"LastUpdatedTime\" VARCHAR(255),\n        \"db\" VARCHAR(255)\n    )\n    as test) as result\n-- The output of cfgbronze data for the column \"TableName\" contains values that are not required and passed in as \"NULL\" so we are ignoring those.\nWhere \"TableName\" is not NULL\nGO\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "gold",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
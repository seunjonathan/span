{
	"name": "Create TOPS Gold and Batch Views",
	"properties": {
		"content": {
			"query": "-- Create database if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'gold')\nBEGIN\n    CREATE DATABASE [gold]\nEND\nGO\n\n\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'tops')\nBEGIN\n    EXEC ('CREATE SCHEMA tops;');\nEND\nGO\n\n-- Create file format if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'DeltaLakeFormat')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = DELTA );\nEND\nGO\n\n-- DROP EXTERNAL DATA SOURCE DeltaLakeStorage\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'DeltaLakeStorage')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE DeltaLakeStorage \n    WITH (\n        LOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net'\n    )\nEND\nGO\n\n\n-- Create view for BOL batch data\n-- Columns which could contain null values use TRY_CAST.\nCREATE OR ALTER VIEW [tops].[vw_BOL]\nAS \nSELECT * FROM (\n    SELECT \n        *,\n        ROW_NUMBER () OVER (PARTITION BY BOL_Number ORDER BY Refresh_Time_UTC desc) as row_number\n    FROM\n    (\n        SELECT\n            CAST ([BOL_Number] AS VARCHAR(255)) AS [BOL_Number]\n            ,TRY_CAST ([Sailing_ID] AS NUMERIC) AS [Sailing_ID]\n            ,CAST ([Container_Type] AS INT) AS [Container_Type]\n            ,TRY_CAST ([Assignment_Status] AS NUMERIC) AS [Assignment_Status]\n            ,CAST ([Hazardous_Goods] AS BIT) AS [Hazardous_Goods]\n            ,CAST ([Length] AS FLOAT) AS [Trailer_Length]\n            ,CAST ([Front_Overhang] AS FLOAT) AS [Trailer_Overhang_Front]\n            ,CAST ([Rear_Overhang] AS FLOAT) AS [Trailer_Overhang_Back]\n            ,TRY_CAST ([Signature_DateTime] AS DATETIME2) AS [Signature_Date_Time]\n            ,TRY_CAST ([Actual_Picked_Up_DateTime] AS DATETIME2) AS [Actual_Picked_Up_Date_Time]\n            ,CAST ([Route] AS INT) AS [Route]\n            ,CAST ([Added_dt] AS DATETIME2) AS [Added_Date]\n            ,CAST ([Preferred_Pickup_Date_Time_official] AS DATETIME2) AS [Preferred_Pickup_Date_Time_official]\n            ,CAST ([Preferred_Pickup_Date_Time] AS DATETIME2) AS [Preferred_Pickup_Date_Time]\n            ,TRY_CAST ([Deleted_Date] AS DATETIME2) AS [Deleted_Date]\n            ,TRY_CAST ([DG_Authorized] AS BIT) AS [DG_Authorized]\n            ,TRY_CAST ([Status] AS DATETIME2) AS [Status]\n            ,CAST ([pk_Job_in] AS INT) AS [pk_Job_in]\n            ,CAST ([fk_Customer_in] AS INT) AS [fk_Customer_in]\n            ,CAST ([fk_MovementMode_in] AS INT) AS [fk_MovementMode_in]\n            ,[Unit_Number]\n            ,CAST ([Reservation_used_TEU] AS INT) AS [Reservation_used_TEU]\n            ,Refresh_Time_UTC\n        FROM\n            OPENROWSET(\n                BULK 'gold/TOPSv2/T_BOL',\n                DATA_SOURCE = 'DeltaLakeStorage',\n                FORMAT = 'Delta'\n        ) a\n    ) b\n) c\nwhere row_number = 1\nGO\n\n\n-- Create view for Sailing \n\nCREATE OR ALTER VIEW [tops].[vw_SAILING]\nAS \nSELECT * FROM (\n    SELECT \n        *,\n        ROW_NUMBER() OVER (PARTITION BY Sailing_ID ORDER BY Refresh_Time_UTC DESC) AS row_num\n    FROM\n    (\n        SELECT\n            CAST ([Sailing_ID] AS NUMERIC) AS [Sailing_ID]\n            ,CAST ([Scheduled_Depature_Date_time] AS DATETIME2) AS [Scheduled_Departure_Date_Time]\n            ,CAST ([Actual_Departure_Date_Time] AS DATETIME2) AS [Actual_Departure_Date_Time]\n            ,CAST ([Depature_Variance] AS NUMERIC) AS [Departure_Variance]  --long\n            ,CAST ([Scheduled_Arrival_Date_Time] AS DATETIME2) AS [Scheduled_Arrival_Date_Time]\n            ,CAST ([Actual_Arrival_DateTime] AS DATETIME2) AS [Actual_Arrival_Date_Time]\n            ,CAST ([Arrival_Variance] AS NUMERIC) AS [Arrival_Variance]  --long\n            ,CAST ([Add_Date] AS DATETIME2) AS [Add_Date]\n            ,TRY_CAST ([Deleted_Date] AS DATETIME2) AS [Deleted_Date]\n            ,[Lock_Sailing]\n            ,CAST ([fk_Truck_in] AS INT) AS [fk_Truck_in]\n            ,CAST ([fk_route_in] AS INT) AS [fk_Route_in]            \n            ,Refresh_Time_UTC\n        FROM\n            OPENROWSET(\n                BULK 'gold/TOPSv2/T_SAILING',\n                DATA_SOURCE = 'DeltaLakeStorage',\n                FORMAT = 'Delta'\n      ) a\n    ) b\n) c\nwhere c.row_num = 1\nGO\n\n\n-- Create view for TURNAROUND_METRICS \n\nCREATE OR ALTER VIEW [tops].[vw_TURNAROUND_METRICS]\nAS \n    (\n        SELECT\n            *\n        FROM\n            OPENROWSET(\n                BULK 'gold/TOPSv2/TURNAROUND_METRICS',\n                DATA_SOURCE = 'DeltaLakeStorage',\n                FORMAT = 'Delta'\n      ) a\n    )\nGO\n\n\n\n\n-- Create view for MISSED_TRAILER_METRICS\nCREATE OR ALTER VIEW [tops].[vw_MISSED_TRAILER_METRICS]\nAS \n    (\n        SELECT\n            *\n        FROM\n            OPENROWSET(\n                BULK 'gold/TOPSv2/MISSED_TRAILER_METRICS',\n                DATA_SOURCE = 'DeltaLakeStorage',\n                FORMAT = 'Delta'\n            ) a\n    )\nGO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "gold",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
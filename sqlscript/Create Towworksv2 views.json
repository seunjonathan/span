{
	"name": "Create Towworksv2 views",
	"properties": {
		"content": {
			"query": "-- CREATE DATABASE silver\n-- USE silver\n\n-- CREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = DELTA );\n\n-- -- DROP EXTERNAL DATA SOURCE DeltaLakeStorage\n-- CREATE EXTERNAL DATA SOURCE DeltaLakeStorage \n-- WITH (\n-- \tLOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net'\n--)\n\n-- This script will create views for all of Towworksv2 tables names listed\n---------------------------------------------------------------------------\n\n-- DROP TABLE IF EXISTS #tmp_data\n\n;WITH cte_data AS (\n    SELECT * FROM (\n        VALUES\n        ('APINVOICES'),\n        ('ARINVOICES'),\n        ('ASSET'),\n        ('BASEAUDIT'),\n        ('CARGO'),\n        ('COMPANY'),\n        ('CONTRACTS'),\n        ('CUSTOMCOLORS'),\n        ('DELETEDEVENTS'),\n        ('DELETIONAUDIT'),\n        ('ETAESTIMATES'),\n        ('EVENTS'),\n        ('DISTRIBUTIONS'),\n        ('LOCATION'),\n        ('LOGISTICSORDERS'),\n        ('LOGISTICSORDERSLINEITEMCARGO'),\n        ('LOGISTICSORDERSLINEITEMS'),\n        ('RATEESCALATORS'),\n        ('RATES'),\n        ('ROUTEPARTIES'),\n        ('TRANSACTIONS'),\n        ('TRIPS'),\n        ('UNITOFMEASURE'),\n        ('WORKORDERLINKS'),\n        ('WORKORDERS'),\n        ('WORKORDERSASUPPLEMENT'),\n        ('WORKORDERSTATUS'),\n        ('WORKTASKS')\n    ) AS t(objname)\n),\ncte_maindata AS (\n    SELECT\n        ROW_NUMBER() OVER(ORDER BY (SELECT NULL)) AS rownum,\n        c.objname,\n        CASE\n            WHEN c.objname IN ('ASSET', 'CARGO','COMPANY','CUSTOMCOLORS','LOCATION','ETAESTIMATES','UNITOFMEASURE','WORKORDERSTATUS') THEN\n                CAST('CREATE OR ALTER VIEW [towworks].[vw_DIM_' + c.objname + ']\n                AS SELECT *\n                FROM  \n                    OPENROWSET(\n                        BULK ''silver/TOWWORKSv2/' + c.objname + ''',\n                        DATA_SOURCE = ''DeltaLakeStorage'',\n                        FORMAT=''DELTA''\n                    ) ai' AS NVARCHAR(2000))\n            ELSE\n                CAST('CREATE OR ALTER VIEW [towworks].[vw_FACT_' + c.objname + ']\n                AS SELECT *\n                FROM  \n                    OPENROWSET(\n                        BULK ''silver/TOWWORKSv2/' + c.objname + ''',\n                        DATA_SOURCE = ''DeltaLakeStorage'',\n                        FORMAT=''DELTA''\n                    ) ai' AS NVARCHAR(2000))\n        END AS ViewScript\n    FROM cte_data c\n)\nSELECT *\nINTO #tmp_data\nFROM cte_maindata\n\nDECLARE @viewname NVARCHAR(1000);\nDECLARE @i INT = 1\nDECLARE @tablerecords INT = (SELECT COUNT(*) FROM #tmp_data)\n\nWHILE @i <= @tablerecords\nBEGIN\n    SELECT @viewname = ViewScript FROM #tmp_data WHERE rownum = @i\n    PRINT (@viewname)\n    EXEC (@viewname)\n    SET @i += 1;\nEND;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "silver",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
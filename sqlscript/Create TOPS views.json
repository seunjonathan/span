{
	"name": "Create TOPS views",
	"properties": {
		"content": {
			"query": "-- Create database if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'silver')\nBEGIN\n    CREATE DATABASE [silver]\nEND\nGO\n\n-- USE silver\n\n\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'tops')\nBEGIN\n    EXEC ('CREATE SCHEMA tops;');\nEND\nGO\n\n-- Create file format if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'DeltaLakeFormat')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = DELTA );\nEND\nGO\n\n\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'DeltaLakeStorage')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE DeltaLakeStorage\n    WITH (\n        LOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net'\n    )\nEND\nGO\n\n-- This script will create views for the TOPS tables names \n---------------------------------------------------------------------------\n\n\n;\nWITH cte_data AS (\n    SELECT * FROM (\n        VALUES\n        ('T_APPOINTMENT'),\n        ('T_ASSIGNMENT'),\n        ('T_ASSIGNMENTRESERVATIONLOG'),\n        ('T_ASSIGNMENTSTATUS'),\n        ('T_ASSIGNMENT_CUSTOMER'),\n        ('T_ASSIGNMENT_MASTERLOG'),\n        ('T_ASSIGNMENT_TRAILER'),\n        ('T_CHARGETYPE'),\n        ('T_COMPANY'),\n        ('T_CONSIGNMENT'),\n        ('T_CONTAINERTYPE'),\n        ('T_CUSTOMER'),\n        ('T_CUSTOMERTYPE'),\n        ('T_E1BI_CUSTOMERGROUPING'),\n        ('T_E1BI_JOBEXT'),\n        ('T_HAZARD'),\n        ('T_JOB'),\n        ('T_JOBCATEGORY'),\n        ('T_JOBFIELDUPDATED'),\n        ('T_JOBSUMMARY'),\n        ('T_JOB_MASTERLOG'),\n        ('T_MASTERLOG'),\n        ('T_MOVEMENTMODE'),\n        ('T_OTG_POD'),\n        ('T_ROUTE'),\n        ('T_SALE'),\n        ('T_SALEINVOICE'),\n        ('T_TRAILERTYPE'),\n        ('T_TRANSPORTPLAN'),\n        ('T_TRANSPORTPLAN_CUSTOMER'),\n        ('T_TRANSPORTPLAN_TRAILER'),\n        ('T_TRUCK'),\n        ('T_TRUNK'),\n        ('T_TRUNKSUMMARY'),\n        ('T_USER'),\n        ('T_WAYPOINT'),\n        ('T_WEB_CUSTOMERLOGIN'),\n        ('V_WC_BI_ASSIGNEMNT'),\n        ('V_WC_BI_SAILINGANALYSIS')\n    ) AS t(objname)\n),\ncte_maindata AS (\n    SELECT\n        ROW_NUMBER() OVER(ORDER BY (SELECT NULL)) AS rownum,\n        c.objname,\n        CASE  -- We use a case statement incase we anticipate future customizations\n            WHEN c.objname IN \n            ('T_APPOINTMENT',\n            'T_ASSIGNMENT',\n            'T_ASSIGNMENTRESERVATIONLOG',\n            'T_ASSIGNMENTSTATUS',\n            'T_ASSIGNMENT_CUSTOMER',\n            'T_ASSIGNMENT_MASTERLOG',\n            'T_ASSIGNMENT_TRAILER',\n            'T_CHARGETYPE',\n            'T_COMPANY',\n            'T_CONSIGNMENT',\n            'T_CONTAINERTYPE',\n            'T_CUSTOMER',\n            'T_CUSTOMERTYPE',\n            'T_E1BI_CUSTOMERGROUPING',\n            'T_E1BI_JOBEXT',\n            'T_HAZARD',\n            'T_JOB',\n            'T_JOBCATEGORY',\n            'T_JOBFIELDUPDATED',\n            'T_JOBSUMMARY',\n            'T_JOB_MASTERLOG',\n            'T_MASTERLOG',\n            'T_MOVEMENTMODE',\n            'T_OTG_POD',\n            'T_ROUTE',\n            'T_SALE',\n            'T_SALEINVOICE',\n            'T_TRAILERTYPE',\n            'T_TRANSPORTPLAN',\n            'T_TRANSPORTPLAN_CUSTOMER',\n            'T_TRANSPORTPLAN_TRAILER',\n            'T_TRUCK',\n            'T_TRUNK',\n            'T_TRUNKSUMMARY',\n            'T_USER',\n            'T_WAYPOINT',\n            'T_WEB_CUSTOMERLOGIN',\n            'V_WC_BI_ASSIGNEMNT',\n            'V_WC_BI_SAILINGANALYSIS')\n \n            THEN\n                CAST('CREATE OR ALTER VIEW [tops].[vw_' + c.objname + ']\n                AS SELECT *\n                FROM  \n                    OPENROWSET(\n                        BULK ''silver/TOPSv2/' + c.objname + ''',\n                        DATA_SOURCE = ''DeltaLakeStorage'',\n                        FORMAT=''DELTA''\n                    ) ai' AS NVARCHAR(2000))\n        END AS ViewScript\n    FROM cte_data c\n)\nSELECT *\nINTO #tmp_data\nFROM cte_maindata\n\nDECLARE @viewname NVARCHAR(1000);\nDECLARE @i INT = 1\nDECLARE @tablerecords INT = (SELECT COUNT(*) FROM #tmp_data)\n\nWHILE @i <= @tablerecords\nBEGIN\n    SELECT @viewname = ViewScript FROM #tmp_data WHERE rownum = @i\n    PRINT (@viewname)\n    EXEC (@viewname)\n    SET @i += 1;\nEND;\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "silver",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
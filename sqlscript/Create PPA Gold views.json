{
	"name": "Create PPA Gold views",
	"properties": {
		"content": {
			"query": "-- Create database if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'gold')\nBEGIN\n    CREATE DATABASE [gold]\nEND\nGO\n\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'ppa')\nBEGIN\n    -- Create Schema has to be the first statement to work - so we wrap it in EXEC\n    EXEC ('CREATE SCHEMA ppa;');\nEND\nGO\n\n-- Create file format if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'DeltaLakeFormat')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = DELTA );\nEND\nGO\n\n-- DROP EXTERNAL DATA SOURCE DeltaLakeStorage\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'DeltaLakeStorage')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE DeltaLakeStorage \n    WITH (\n        LOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net'\n    )\nEND\nGO\n\n-- Create view for PPA Market Share Report\n-- DROP VIEW [PPA].[vw_REPORT_MARKET_SHARE]\n-- While converting PPA_Departure_Calendar to PST we use 112 (yyyymmdd) as it is required format\n-- Please refer to this https://learn.microsoft.com/en-us/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-ver16 link for more information\n\nCREATE OR ALTER VIEW [ppa].[vw_REPORT_PPA_MARKET_SHARE]\nAS SELECT \n    number,\n    status,\n    vesselId,\n    organizationId,\n    PPA_billing_agencyID,\n    Tariff_Area_To,\n    from_is_preferred,\n    to_is_preferred,\n    AwardedFromTo_distinct,\n    AwardedJob,\n    LocationJob,\n    LOCATIONTO,\n    name,\n    AwardedFrom,\n    AwardedTo,\n    Tariff_Area_From,\n    orderingContactName,\n    organizationName,\n    Agency,\n    PILOT1,\n    PILOT2,\n    LOCATIONFROM,\n    Seaspan_Time AS Seaspan_Time_PST,\n    id,\n    jobRemarks,\n    orderingContactId,\n    pilot2Id,\n    tugCompanyFromLocation,\n    tugCompanyToLocation,\n    PPA_numberOfTugsRequired,\n    PPA_lastmodifydate AS PPA_lastmodifydate_PST,\n    actualDraft,\n    actualSpeed,\n    pilot1Id,\n    PPA_agentContactName,\n    fromLocationId,\n    toLocationId,\n    fromLanding,\n    toLanding,\n    region,\n    updatedAt AS updatedAt_UTC,\n    createdAt AS createdAt_UTC,\n    etd_atd AS etd_atd_UTC,\n    orderTime AS orderTime_UTC,\n    eta_ata AS eta_ata_UTC,\n    dispatchTime AS dispatchTime_UTC,\n    PPA_Departure_Calendar AS PPA_Departure_Calendar_UTC,\n    updatedAt AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time' AS updatedAt_PST,\n    createdAt AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time' AS createdAt_PST,\n    etd_atd AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time' AS etd_atd_PST,\n    orderTime AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time' AS orderTime_PST,\n    eta_ata AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time' AS eta_ata_PST,\n    dispatchTime AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time' AS dispatchTime_PST,\n    CASE WHEN etd_atd AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time' IS NOT NULL\n        THEN CAST(CONVERT(VARCHAR(8), etd_atd AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time', 112) AS INT)\n        ELSE NULL\n    END AS PPA_Departure_Calendar_PST\n    \nFROM  \n    OPENROWSET(\n        BULK 'gold/PPA/REPORT_PPA_MARKET_SHARE',\n        DATA_SOURCE = 'DeltaLakeStorage',\n        FORMAT = 'DELTA'\n    ) ver\nGO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "gold",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
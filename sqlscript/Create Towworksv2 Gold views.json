{
	"name": "Create Towworksv2 Gold views",
	"properties": {
		"description": "This script creates the gold views that are used to back reports and dashboards.\n\nThe script first checks the presence of various database objects. As such it is idempotent and can be ran without any prerequisite state.",
		"content": {
			"query": "-- Create database if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'gold')\nBEGIN\n    CREATE DATABASE [gold]\nEND\nGO\n\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'towworks')\nBEGIN\n    -- Create Schema has to be the first statement to work - so we wrap it in EXEC\n    EXEC ('CREATE SCHEMA towworks;');\nEND\nGO\n\n-- Create file format if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'DeltaLakeFormat')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = DELTA );\nEND\nGO\n\n-- DROP EXTERNAL DATA SOURCE DeltaLakeStorage\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'DeltaLakeStorage')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE DeltaLakeStorage \n    WITH (\n        LOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net'\n    )\nEND\nGO\n\n-- Create view for Exception Report\n-- DROP VIEW [towworks].[vw_REPORT_EXCEPTION]\nCREATE OR ALTER VIEW [towworks].[vw_REPORT_EXCEPTION]\nAS SELECT \n    ByAssetGuid, Work_Order_Number, Event_GUID, LINKNUMBER, Event_Name, Start_Time, End_Time,\n    Overlapping_Work_Order_Numbers, Overlapping_Event_Guids, Other_Event_Names,\n    overlaps_in_sec,\n    ToLocationGuid, FromLocationGuid, ToAssetGuid\nFROM  \n    OPENROWSET(\n        BULK 'gold/TOWWORKSv2/EXCEPTIONS',\n        DATA_SOURCE = 'DeltaLakeStorage',\n        FORMAT = 'DELTA'\n    )\n    WITH (\n        ByAssetGuid VARCHAR (255),\n        Work_Order_Number VARCHAR(255),\n        Event_GUID VARCHAR(255),\n        LINKNUMBER VARCHAR(255),\n        Event_Name VARCHAR(255),\n        Start_Time DATETIME2,\n        End_Time DATETIME2,\n        Overlapping_Work_Order_Numbers VARCHAR(max),\n        Overlapping_Event_Guids VARCHAR(max),\n        Other_Event_Names VARCHAR(max),\n        overlaps_in_sec VARCHAR(max),\n        ToLocationGuid VARCHAR(255),\n        FromLocationGuid VARCHAR(255),\n        ToAssetGuid VARCHAR(255)\n    )\n    AS er\nGO\n\n\n-- Create view for Valid Events Report\n-- DROP VIEW [towworks].[vw_REPORT_VALID_EVENTS]\nCREATE OR ALTER VIEW [towworks].[vw_REPORT_VALID_EVENTS]\nAS SELECT \n    *\nFROM  \n    OPENROWSET(\n        BULK 'gold/TOWWORKSv2/VALIDEVENTS',\n        DATA_SOURCE = 'DeltaLakeStorage',\n        FORMAT = 'DELTA'\n    ) ver\nGO\n\n\n-- Create view for Fleet and Vessel Performance Report\n-- DROP VIEW [towworks].[vw_REPORT_FLEET_VESSEL_PERFORMANCE]\nCREATE OR ALTER VIEW [towworks].[vw_REPORT_FLEET_VESSEL_PERFORMANCE]\nAS SELECT \n    *\nFROM  \n    OPENROWSET(\n        BULK 'gold/TOWWORKSv2/FLEETANDVESSELPERFORMANCE',\n        DATA_SOURCE = 'DeltaLakeStorage',\n        FORMAT = 'DELTA'\n    ) ver\nGO\n\n\n-- Create view for VPA  Report\n-- DROP VIEW [towworks].[vw_REPORT_VPA]\nCREATE OR ALTER VIEW [towworks].[vw_REPORT_VPA]\nAS SELECT \n    *\nFROM  \n    OPENROWSET(\n        BULK 'gold/TOWWORKSv2/VPA',\n        DATA_SOURCE = 'DeltaLakeStorage',\n        FORMAT = 'DELTA'\n    ) vpa\nGO\n\n\n-- Create view for Transport Canada (Raw Data tab)\n-- The column names match those that appear in the `Raw Data` tab of `Data 2020 Transport Canada V2.xlsx`\n-- DROP VIEW [towworks].[vw_REPORT_TRANSPORT_CANADA]\nCREATE OR ALTER VIEW [towworks].[vw_REPORT_TRANSPORT_CANADA]\nAS SELECT \n        Job as [Job #],\n        VesselName as [Vessel Name],\n        ShipBarge as [Ship/Barge],        \n        Product as [Product],\n        FromLocation as [From Location],\n        LoadLocation as [Load Location],\n        DestinationPort as [Destination/Port],\n        ToLocation as [To Location],\n        WightinT as [Wight in T], -- Typo is deliberate - to match column name observed in target Excel \n        Unitsofmeasures as [Units of measures],\n        LoadStart as [Load start],\n        LoadEnd as [Load end],\n        DischargeStart as [Discharge Start],\n        DischargeEnd as [Discharge End]\nFROM  \n    OPENROWSET(\n        BULK 'gold/TOWWORKSv2/TRANSPORT_CANADA',\n        DATA_SOURCE = 'DeltaLakeStorage',\n        FORMAT = 'DELTA'\n    )\n    WITH (\n        Job VARCHAR(255),\n        VesselName VARCHAR(1000),\n        ShipBarge VARCHAR(255),\n        Product VARCHAR(255),\n        FromLocation VARCHAR(255),\n        LoadLocation VARCHAR(255),\n        DestinationPort VARCHAR(255),\n        ToLocation VARCHAR(255),\n        WightinT FLOAT,\n        Unitsofmeasures VARCHAR(255),\n        Loadstart DATETIME2,\n        Loadend DATETIME2,\n        DischargeStart DATETIME2,\n        DischargeEnd DATETIME2\n    )\n    AS tc\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "gold",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
{
	"name": "Create TOPS Fast Track Views",
	"properties": {
		"description": "This script is to satisfy story 2907 in which we build a near real time ETL for three TOPS tables. This script creates the views for the BOL, SAILING and LOCATION tables.\n\nThe data is delivered by a function app that creates parquet data. ",
		"content": {
			"query": "-- Create database if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'silver')\nBEGIN\n    CREATE DATABASE [silver]\nEND\nGO\n\nUSE silver\nGO\n\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'tops')\nBEGIN\n    EXEC ('CREATE SCHEMA tops;');\nEND\nGO\n\n-- Create file format if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'ParquetFormat')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT ParquetFormat WITH ( FORMAT_TYPE = PARQUET );\nEND\nGO\n\n-- DROP EXTERNAL DATA SOURCE ParquetStorage\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'ParquetStorage')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE ParquetStorage\n    WITH (\n        LOCATION = 'abfss://transient@adlssmgdev.dfs.core.windows.net'\n    )\nEND\nGO\n\n\n-- Create view for BOL fast track data\n-- DROP VIEW [tops].[vw_FastTrack_BOL]\n-- Columns which could contain null values use TRY_CAST.\nCREATE OR ALTER VIEW [tops].[vw_FastTrack_BOL]\nAS \nSELECT * FROM (\n    SELECT \n        *,\n        ROW_NUMBER() OVER (PARTITION BY BOL_Number ORDER BY Refresh_Time_UTC DESC) AS row_num\n    FROM\n    (\n        SELECT\n            CAST ([BOL_Number] AS VARCHAR(255)) AS [BOL_Number]\n            ,TRY_CAST ([Sailing_ID] AS NUMERIC) AS [Sailing_ID]\n            ,CAST ([Container_Type] AS INT) AS [Container_Type]\n            ,TRY_CAST ([Assignment_Status] AS NUMERIC) AS [Assignment_Status]\n            ,CAST ([Hazardous_Goods] AS BIT) AS [Hazardous_Goods]\n            ,CAST ([Trailer_Length] AS FLOAT) AS [Trailer_Length]\n            ,TRY_CAST ([Trailer_Overhang_Front] AS FLOAT) AS [Trailer_Overhang_Front]\n            ,CAST ([Trailer_Overhang_Back] AS FLOAT) AS [Trailer_Overhang_Back]\n            ,TRY_CAST ([Signature_Date_Time] AS DATETIME2) AS [Signature_Date_Time]\n            ,TRY_CAST ([Actual_Picked_Up_Date_Time] AS DATETIME2) AS [Actual_Picked_Up_Date_Time]\n            ,CAST ([Route] AS INT) AS [Route]\n            ,CAST ([Added_Date] AS DATETIME2) AS [Added_Date_Time]\n            ,CAST ([Preferred_Pickup_Date_Time_official] AS DATETIME2) AS [Preferred_Pickup_Date_Time_official]\n            ,CAST ([Preferred_Pickup_Date_Time] AS DATETIME2) AS [Preferred_Pickup_Date_Time]\n            ,TRY_CAST ([Deleted_Date] AS DATETIME2) AS [Deleted_Date]\n            ,TRY_CAST ([DG_Authorized] AS BIT) AS [DG_Authorized]\n            ,TRY_CAST ([Status] AS DATETIME2) AS [Status]\n            ,CAST ([pk_Job_in] AS INT) AS [pk_Job_in]\n            ,CAST ([fk_Customer_in] AS INT) AS [fk_Customer_in]\n            ,CAST ([fk_MovementMode_in] AS INT) AS [fk_MovementMode_in]\n            ,[Unit_Number]\n            ,CAST ([Reservation_used_TEU] AS INT) AS [Reservation_used_TEU]\n            ,Refresh_Time_UTC\n        FROM\n            OPENROWSET(\n                BULK 'silver/TOPSv2/T_BOL',\n                DATA_SOURCE = 'ParquetStorage',\n                FORMAT = 'Parquet'\n        ) a\n    ) b\n) c\nwhere c.row_num = 1\nGO\n\n\n\n-- Create view for SAILING fast track data\n\nCREATE OR ALTER VIEW [tops].[vw_FastTrack_SAILING]\nAS \nSELECT * FROM (\n    SELECT \n        *,\n        ROW_NUMBER() OVER (PARTITION BY Sailing_ID ORDER BY Refresh_Time_UTC DESC) AS row_num\n    FROM\n    (\n        SELECT\n            CAST ([Sailing_ID] AS NUMERIC) AS [Sailing_ID]\n            ,CAST ([Scheduled_Departure_Date_time] AS DATETIME2) AS [Scheduled_Departure_Date_Time]\n            ,TRY_CAST ([Actual_Departure_DateTime] AS DATETIME2) AS [Actual_Departure_Date_Time]        \n            ,TRY_CAST ([Departure_Variance] AS FLOAT) AS [Departure_Variance]\n            ,CAST ([Scheduled_Arrival_Date_time] AS DATETIME2) AS [Scheduled_Arrival_Date_Time]\n            ,TRY_CAST ([Actual_Arrival_DateTime] AS DATETIME2) AS [Actual_Arrival_Date_Time]\n            ,TRY_CAST ([Arrival_Variance] AS FLOAT) AS [Arrival_Variance]\n            ,TRY_CAST ([Add_Date] AS DATETIME2) AS [Add_Date]\n            ,TRY_CAST ([Deleted_Date] AS DATETIME2) AS [Deleted_Date]\n            ,TRY_CAST ([Lock_Sailing] AS VARCHAR) AS [Lock_Sailing]\n            ,CAST ([fk_Truck_in] AS INT) AS [fk_Truck_in]\n            ,CAST ([fk_route_in] AS INT) AS [fk_Route_in]\n            ,Refresh_Time_UTC\n\n        FROM\n            OPENROWSET(\n                BULK 'silver/TOPSv2/T_SAILING',\n                DATA_SOURCE = 'ParquetStorage',\n                FORMAT = 'Parquet'\n        ) a\n    ) b\n) c\nwhere c.row_num = 1\nGO\n\n\n\n-- Create view for LOCATION data\n\nCREATE OR ALTER VIEW [tops].[vw_FastTrack_LOCATION]\nAS \n    (\n        SELECT\n            CAST ([pk_Truck_in] AS NUMERIC) AS [pk_Truck_in]\n            ,[Location_Type]\n            ,[Vessel_Name]\n            ,CAST ([Longitude] AS DECIMAL(14,9)) AS [Longitude]\n            ,CAST ([Latitude] AS DECIMAL(14,9)) AS [Latitude]\n            ,CAST ([Knots] AS DECIMAL(14,9)) AS [Knots]\n            ,CAST ([Heading] AS INT) AS [Heading]\n            ,CAST ([Date_Time] AS DATETIME2) AS [Date_Time]            \n            ,Refresh_Time_UTC\n\n        FROM\n            OPENROWSET(\n                BULK 'silver/TOPSv2/T_LOCATION',\n                DATA_SOURCE = 'ParquetStorage',\n                FORMAT = 'Parquet'\n        ) a\n        )\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "silver",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
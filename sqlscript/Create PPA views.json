{
	"name": "Create PPA views",
	"properties": {
		"content": {
			"query": "-- Create database if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'silver')\nBEGIN\n    CREATE DATABASE [silver]\nEND\nGO\n\nUSE silver\n\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'ppa')\nBEGIN\n    EXEC ('CREATE SCHEMA ppa;');\nEND\nGO\n\n-- Create file format if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'DeltaLakeFormat')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = DELTA );\nEND\nGO\n\n\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'DeltaLakeStorage')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE DeltaLakeStorage\n    WITH (\n        LOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net'\n    )\nEND\nGO\n\n-- This script will create views for all of PPA tables names listed\n---------------------------------------------------------------------------\n\n-- DROP TABLE IF EXISTS #tmp_data\n\n;WITH cte_data AS (\n    SELECT * FROM (\n        VALUES\n        ('Vessels'),\n        ('Organizations'),\n        ('Locations'),\n        ('Pilots'),\n        ('Jobs')\n    ) AS t(objname)\n),\ncte_maindata AS (\n    SELECT\n        ROW_NUMBER() OVER(ORDER BY (SELECT NULL)) AS rownum,\n        c.objname,\n        CASE\n            WHEN c.objname IN ('Vessels', 'Organizations','Locations','Pilots') THEN\n                CAST('CREATE OR ALTER VIEW [ppa].[vw_DIM_' + c.objname + ']\n                  AS SELECT \n                    updatedAt AT TIME ZONE ''UTC'' AT TIME ZONE ''Pacific Standard Time'' AS updatedAt_PST,\n                    createdAt AT TIME ZONE ''UTC'' AT TIME ZONE ''Pacific Standard Time'' AS createdAt_PST,\n                    *\n                FROM  \n                    OPENROWSET(\n                        BULK ''silver/PPA/' + c.objname + ''',\n                        DATA_SOURCE = ''DeltaLakeStorage'',\n                        FORMAT=''DELTA''\n                    ) ai' AS NVARCHAR(2000))\n            ELSE\n                CAST('CREATE OR ALTER VIEW [ppa].[vw_FACT_' + c.objname + ']\n                    AS SELECT \n                        updatedAt AT TIME ZONE ''UTC'' AT TIME ZONE ''Pacific Standard Time'' AS updatedAt_PST,\n                        createdAt AT TIME ZONE ''UTC'' AT TIME ZONE ''Pacific Standard Time'' AS createdAt_PST,\n                        etd_atd AT TIME ZONE ''UTC'' AT TIME ZONE ''Pacific Standard Time'' AS etd_atd_PST,\n                        orderTime AT TIME ZONE ''UTC'' AT TIME ZONE ''Pacific Standard Time'' AS orderTime_PST,\n                        eta_ata AT TIME ZONE ''UTC'' AT TIME ZONE ''Pacific Standard Time'' AS eta_ata_PST,\n                        dispatchTime AT TIME ZONE ''UTC'' AT TIME ZONE ''Pacific Standard Time'' AS dispatchTime_PST,\n                        *\n                FROM  \n                    OPENROWSET(\n                        BULK ''silver/PPA/' + c.objname + ''',\n                        DATA_SOURCE = ''DeltaLakeStorage'',\n                        FORMAT=''DELTA''\n            ) ai' AS NVARCHAR(2000))\n\n        END AS ViewScript\n    FROM cte_data c\n)\nSELECT *\nINTO #tmp_data\nFROM cte_maindata\n\nDECLARE @viewname NVARCHAR(1000);\nDECLARE @i INT = 1\nDECLARE @tablerecords INT = (SELECT COUNT(*) FROM #tmp_data)\n\nWHILE @i <= @tablerecords\nBEGIN\n    SELECT @viewname = ViewScript FROM #tmp_data WHERE rownum = @i\n    PRINT (@viewname)\n    EXEC (@viewname)\n    SET @i += 1;\nEND;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "silver",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
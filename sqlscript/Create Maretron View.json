{
	"name": "Create Maretron View",
	"properties": {
		"description": "This script is used to create the schema and views for the Maretron telemetry data.",
		"content": {
			"query": "USE silver;\nGO\n\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'maretron')\nBEGIN\n    EXEC ('CREATE SCHEMA maretron;');\nEND\nGO\n\n-- The view is created on top of CSV data which is stored  in processed/silver/maretron folder in our Delta \n-- lake storage account. Collation of VARCHAR fields has to be explicitly\n-- defined for UTF8 otherwise order/sort queries on the data fail.  \n--\nCREATE OR ALTER VIEW [maretron].[vw_Telemetry]\nAS SELECT \n    Timestamp_UTC AT TIME ZONE 'UTC' AT TIME ZONE 'Pacific Standard Time' AS Timestamp_PST,\n    [DAT_0],\n    [TIM_0],\n    [vessel_name],\n    [COG_0],\n    [COG_255],\n    [EFR_0],\n    [EFR_1],\n    [ETH_0],\n    [FFR_0],\n    [L/L_255],\n    [SOG_0],\n    [SOG_255],\n    [TFT_255],\n    [TTF_255],\n    [Lat],\n    [Long],\n    CASE \n        WHEN [STW_0] IS NOT NULL THEN [STW_0]\n        WHEN [STW_2] IS NOT NULL THEN [STW_2]\n        ELSE NULL \n    END AS [STW],\n    [DAT_255],\n    [Timestamp_UTC],\n    [row]\nFROM  \n    OPENROWSET(\n        BULK 'https://adlssmgdev.dfs.core.windows.net/processed/silver/MARETRON/*.csv',\n        FORMAT = 'CSV',\n        PARSER_VERSION = '2.0',\n        HEADER_ROW = TRUE\n    ) \nWITH (\n    [DAT_0] BIGINT,\n    [TIM_0] BIGINT,\n    [vessel_name] VARCHAR (256) COLLATE Latin1_General_100_BIN2_UTF8,\n    [COG_0] FLOAT,\n    [COG_255] FLOAT,\n    [EFR_0] FLOAT,\n    [EFR_1] FLOAT,\n    [ETH_0] FLOAT,\n    [FFR_0] FLOAT,\n    [L/L_255] VARCHAR(256) COLLATE Latin1_General_100_BIN2_UTF8,\n    [SOG_0] FLOAT,\n    [SOG_255] FLOAT,\n    [TFT_255] FLOAT,\n    [TTF_255] FLOAT,\n    [Lat] FLOAT,\n    [Long] FLOAT,\n    [STW_0] FLOAT,\n    [STW_2] FLOAT,\n    [DAT_255] VARCHAR(256) COLLATE Latin1_General_100_BIN2_UTF8,\n    [Timestamp_UTC] DATETIME2,\n    [row] FLOAT\n)\n    AS [result]\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "silver",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
{
	"name": "Service Account for Towworks",
	"properties": {
		"description": "This script created to support request by Richard Luther for access to our Towworks data via a service account.",
		"content": {
			"query": "-- 2891 Create a SQL account --------------------------------------------\n-- Since we need to create new views, we will do so using a new schema. Otherwise, the [towworks] schema\n-- will look very cluttered! The new schema will be [towworks_aux]\n\nuse master\nCREATE LOGIN [smg.towworksuser] WITH PASSWORD = '<password goes here>'\nGO\n\nuse silver\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'towworks_aux')\nBEGIN\n    EXEC ('CREATE SCHEMA towworks_aux;');\nEND\nGO\n\n-- Then create a user\nuse silver\nCREATE USER [smg.towworksuser] FROM LOGIN [smg.towworksuser] WITH DEFAULT_SCHEMA=[towworks_aux]\nGO\n\n-- Next grant user access to schema\nGRANT SELECT ON SCHEMA :: towworks_aux TO [smg.towworksuser] WITH GRANT OPTION\nGO\n\n-- Create a data source protected by a MI\n-- One time only - create a master key\nuse silver\nCREATE MASTER KEY ENCRYPTION BY PASSWORD = '<master-key goes here>';\nGO\n\n-- Next create a MI credential\nIF NOT EXISTS (SELECT * FROM sys.database_scoped_credentials WHERE name = 'ManagedIdCredentials')\nBEGIN\n   CREATE DATABASE SCOPED CREDENTIAL ManagedIdCredentials WITH IDENTITY = 'Managed Identity'\nEND\nGO\n\n-- Grant the SQL user access to it.\nGRANT CONTROL ON DATABASE SCOPED CREDENTIAL ::ManagedIdCredentials TO [smg.towworksuser]\nGO\n\n\n-- 2892 ADD MI Credentials to Towworks views\n-- Now create the MI protected source \n--\n-- DROP EXTERNAL DATA SOURCE ManagedIdDeltaLakeSource_TOWWORKSv2\n-- CAUTION: we have a reference to adlssmgdev - this will need to be prod once promoted.\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'ManagedIdDeltaLakeSource_TOWWORKSv2')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE ManagedIdDeltaLakeSource_TOWWORKSv2\n    WITH (\n      LOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net', \n      CREDENTIAL = ManagedIdCredentials\n    )\nEND\nGO\n\n-- This script lifted from `Create Towworksv2 view` and modified to use the MI DATA_SOURCE and [towworks_aux] schema\n--\nWITH cte_data AS (\n    SELECT * FROM (\n        VALUES\n        ('APINVOICES'),\n        ('ARINVOICES'),\n        ('ASSET'),\n        ('BASEAUDIT'),\n        ('CARGO'),\n        ('COMPANY'),\n        ('CONTRACTS'),\n        ('CUSTOMCOLORS'),\n        ('DELETEDEVENTS'),\n        ('DELETIONAUDIT'),\n        ('ETAESTIMATES'),\n        ('EVENTS'),\n        ('DISTRIBUTIONS'),\n        ('LOCATION'),\n        ('LOGISTICSORDERS'),\n        ('LOGISTICSORDERSLINEITEMCARGO'),\n        ('LOGISTICSORDERSLINEITEMS'),\n        ('RATEESCALATORS'),\n        ('RATES'),\n        ('ROUTEPARTIES'),\n        ('TRANSACTIONS'),\n        ('TRIPS'),\n        ('UNITOFMEASURE'),\n        ('WORKORDERLINKS'),\n        ('WORKORDERS'),\n        ('WORKORDERSASUPPLEMENT'),\n        ('WORKORDERSTATUS'),\n        ('WORKTASKS')\n    ) AS t(objname)\n),\ncte_maindata AS (\n    SELECT\n        ROW_NUMBER() OVER(ORDER BY (SELECT NULL)) AS rownum,\n        c.objname,\n        CASE\n            WHEN c.objname IN ('ASSET', 'CARGO','COMPANY','CUSTOMCOLORS','LOCATION','ETAESTIMATES','UNITOFMEASURE','WORKORDERSTATUS') THEN\n                CAST('CREATE OR ALTER VIEW [towworks_aux].[vw_DIM_' + c.objname + ']\n                AS SELECT *\n                FROM  \n                    OPENROWSET(\n                        BULK ''silver/TOWWORKSv2/' + c.objname + ''',\n                        DATA_SOURCE = ''ManagedIdDeltaLakeSource_TOWWORKSv2'',\n                        FORMAT=''DELTA''\n                    ) ai' AS NVARCHAR(2000))\n            ELSE\n                CAST('CREATE OR ALTER VIEW [towworks_aux].[vw_FACT_' + c.objname + ']\n                AS SELECT *\n                FROM  \n                    OPENROWSET(\n                        BULK ''silver/TOWWORKSv2/' + c.objname + ''',\n                        DATA_SOURCE = ''ManagedIdDeltaLakeSource_TOWWORKSv2'',\n                        FORMAT=''DELTA''\n                    ) ai' AS NVARCHAR(2000))\n        END AS ViewScript\n    FROM cte_data c\n)\nSELECT *\nINTO #tmp_data\nFROM cte_maindata\n\nDECLARE @viewname NVARCHAR(1000);\nDECLARE @i INT = 1\nDECLARE @tablerecords INT = (SELECT COUNT(*) FROM #tmp_data)\n\nWHILE @i <= @tablerecords\nBEGIN\n    SELECT @viewname = ViewScript FROM #tmp_data WHERE rownum = @i\n    PRINT (@viewname)\n    EXEC (@viewname)\n    SET @i += 1;\nEND;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "silver",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
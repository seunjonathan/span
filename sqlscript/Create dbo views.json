{
	"name": "Create dbo views",
	"properties": {
		"description": "This script is used to address requirements for some miscellaneous tables such as CALENDAR_DATE that appear in the existing EDW solution.",
		"content": {
			"query": "-- Create database if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'silver')\nBEGIN\n    CREATE DATABASE [silver]\nEND\nGO\n\n\n-- Create schema if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'dbo')\nBEGIN\n    EXEC ('CREATE SCHEMA dbo;');\nEND\nGO\n\n-- Create file format if it does not exist\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'DeltaLakeFormat')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = DELTA );\nEND\nGO\n\n\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'DeltaLakeStorage')\nBEGIN\n    CREATE EXTERNAL DATA SOURCE DeltaLakeStorage\n    WITH (\n        LOCATION = 'abfss://processed@adlssmgdev.dfs.core.windows.net'\n    )\nEND\nGO\n\n-- This script will create views for all of dbo tables names listed\n---------------------------------------------------------------------------\n\n-- DROP TABLE IF EXISTS #tmp_data\n\n;WITH cte_data AS (\n    SELECT * FROM (\n        VALUES\n        ('CALENDAR_DATE')\n    ) AS t(objname)\n),\ncte_maindata AS (\n    SELECT\n        ROW_NUMBER() OVER(ORDER BY (SELECT NULL)) AS rownum,\n        c.objname,\n        CASE  -- We use a case statement incase we anticipate future customizations\n            WHEN c.objname IN ('CALENDAR_DATE') THEN\n                CAST('CREATE OR ALTER VIEW [DBO].[vw_' + c.objname + ']\n                AS SELECT *\n                FROM  \n                    OPENROWSET(\n                        BULK ''silver/DBO/' + c.objname + ''',\n                        DATA_SOURCE = ''DeltaLakeStorage'',\n                        FORMAT=''DELTA''\n                    ) ai' AS NVARCHAR(2000))\n        END AS ViewScript\n    FROM cte_data c\n)\nSELECT *\nINTO #tmp_data\nFROM cte_maindata\n\nDECLARE @viewname NVARCHAR(1000);\nDECLARE @i INT = 1\nDECLARE @tablerecords INT = (SELECT COUNT(*) FROM #tmp_data)\n\nWHILE @i <= @tablerecords\nBEGIN\n    SELECT @viewname = ViewScript FROM #tmp_data WHERE rownum = @i\n    PRINT (@viewname)\n    EXEC (@viewname)\n    SET @i += 1;\nEND;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "silver",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}